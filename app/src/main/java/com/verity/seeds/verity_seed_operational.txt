# VERITY – OPERATIONAL SEED
Inherits from: verity_seed_core.txt
──────────────────────────────────────
PROJECT PHASE MODEL (AUTHORITATIVE)

FOUNDATION PHASES — COMPLETED & LOCKED
• F0 — Reset & Intent ✅
• F1 — Business & Domain Fundamentals ✅
• F2 — Architecture Blueprint ✅
• F3 — UX Laws, Design System & Wireframes ✅
• F4 — Core Implementation Foundations ✅ (LOCKED)

DELIVERY PHASES — UPCOMING
• D1 — Search & Read-Only Experience (Search Mode + Document Viewer) ▶️ NEXT
• D2 — Core Workflows (Invoices & Challans)
• D3 — Experience, Sync & Production

──────────────────────────────────────
Current Focus:
Foundation is complete and constitutionally locked.
The project is transitioning from platform correctness
to visible product delivery.

──────────────────────────────────────
CANONICAL NAVIGATION FLOW (OPERATIONAL, LOCKED)

The application follows a task‑first navigation topology.
This topology is authoritative and must not be re‑routed.
Delivery phases may gate nodes, but must not alter topology.

Default Entry
• App launch lands in Invoice / Challan Workspace (draft‑first).

Primary Modes
• Invoice / Challan Workspace — creation and drafting workspace.
• Search Mode — dedicated recall, comparison, and reuse space.
• Customers — relationship and money management.

Canonical Transitions
• Workspace → Search Mode (explicit user intent).
• Search Mode → Open Document (read‑only PDF view).
• Search Mode → Create from existing → Workspace (new draft; gated until D2).
• Workspace → Customers.
• Customers → Add Payment → Customer Ledger.
• Customer Ledger → Open Document (read‑only).
• Back navigation always returns to the originating context.

Document Viewing Law
• All documents (Invoice / Challan) are opened in a single, read‑only viewer.
• The viewer renders the previously generated authoritative PDF.
• Documents are never edited in place after finalization.

──────────────────────────────────────
Scope:
• Domain-first design (events, invariants, projections).
• Local database (Room) as the sole source of truth.
• Explicit migrations before schema changes.
• Offline-first sync design (cloud as replication target only).
• Test-first enforcement of domain invariants.
• No speculative UI or UX changes.
• Event Sourcing applied surgically to financial and logistical domain truth only.
• Projections treated strictly as rebuildable performance caches.
• Replay-first design with incremental (delta-based) rebuilds for scalability.
• Version-catalog–driven dependency management (no ad-hoc plugin or library versions).
• Platform module is the exclusive owner of persistence technologies (Room, KSP).
• Financial ledger projection pipeline (map → replay → project) implemented and test‑backed.
• Document Index projection pipeline (map → replay → project) implemented and test‑backed.
• PlatformReplayCoordinator is the sole entry point for invoking projection replay and rebuilds.

──────────────────────────────────────
Current Working Components:
core/domain/
    ├─ events (Invoice, Payment, Customer lifecycle events)
    ├─ invariants (ledger, balance, immutability rules)

platform/database/
    ├─ Room entities & DAOs
    ├─ Explicit migrations (versioned, tested)
    ├─ EventEntity (append-only event store)
    ├─ LedgerBalanceEntity (rebuildable ledger projection)
    ├─ LedgerBalanceDao (projection-only persistence)
    ├─ LedgerProjectionWriter (incremental replay orchestration)
    ├─ DocumentIndexEntity (search/navigation projection)
    ├─ DocumentIndexDao (projection-only persistence)
    ├─ DocumentIndexProjectionWriter (incremental & full replay orchestration)
    ├─ KSP-backed Room configuration (platform-only)

platform/cloud/
    ├─ Sync boundaries & replication logic (no UI coupling)

tests/
    ├─ Domain invariant tests
    ├─ Ledger rebuild tests
    ├─ Migration tests
    ├─ LedgerProjectionWriter tests
    ├─ DocumentIndexProjectionWriter tests

core/replay/
    ├─ Pure replay engine (events → LedgerState)
    ├─ LedgerState (balances + audit entries)
    ├─ DocumentIndexState (canonical document index view)
    ├─ DocumentIndexReplayEngine (pure replay from mutations)
platform/replay/
    ├─ PlatformReplayCoordinator (canonical replay entry point)
    ├─ DefaultPlatformReplayCoordinator (Phase‑1 implementation)
    ├─ PlatformReplayableEvent (event adapter)

──────────────────────────────────────
Operational Laws (Frozen for Foundation Phases)
• Local database is the single source of truth.
• All state changes occur via append-only domain events.
• Projections must be fully rebuildable from events.
• No silent data mutation or in-place edits.
• Migrations are mandatory and written before schema changes.
• UI may not compensate for data inconsistency.
• Cloud sync may lag, replay, or fail without corrupting truth.
• Commands express intent; only aggregates may emit domain events.
• Replay explains history; it must never decide or mutate truth.
• Projection tables may be dropped and rebuilt at any time without data loss.
• Performance optimizations must not introduce new sources of truth.
• Build configuration errors are correctness failures, not tooling issues.
• Room, KSP, and migrations must never appear outside the platform module.
• Event storage schema changes require migration tests before merge.
• Projection writers must never be invoked directly outside the PlatformReplayCoordinator.
• Replay execution order is deterministic and centrally enforced.
• Introduction of alternate replay entry points is a constitutional violation.

──────────────────────────────────────
Behavioural Laws for the Assistant:
• Always confirm invariants before proposing data models.
• No Room entities without migration strategy.
• No sync logic without failure and replay semantics.
• Prefer tests and invariants before feature code.
• Stop immediately if correctness is compromised.

──────────────────────────────────────
Current Deliverables (as of Foundation completion):
• Event store (EventEntity + EventDao) locked and tested for replay safety.
• Financial event mapping layer enforced with fail‑loud semantics.
• Deterministic ledger replay engine producing LedgerState.
• Incremental ledger projection writer with embedded cursor strategy.
• Rebuildable ledger balance projection persisted via Room.
• JVM tests covering replay, projection, and failure scenarios.
• Deterministic Document Index replay engine deriving canonical document state.
• Incremental, cursor‑driven Document Index projection writer (idempotent & crash‑safe).
• Rebuildable document index projection persisted via Room.
• JVM tests covering Document Index replay, projection, and failure semantics.
• PlatformReplayCoordinator implemented as the single canonical replay entry point.
• Ledger and Document Index projection writers normalized to a common invocation contract.
